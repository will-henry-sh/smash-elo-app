<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ name }}</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>

  <body>
    <div class="container">
      <h1>{{ name }}</h1>

      <a href="/leaderboard" class="nav-link">← Back to Leaderboard</a>

      <!-- Player Match Stats -->
      <div class="player-stats-box">
        <h2>Player Data</h2>

        <p><strong>Total Matches:</strong> {{ total_matches }}</p>
        <p><strong>Wins:</strong> {{ wins }}</p>
        <p><strong>Losses:</strong> {{ losses }}</p>
        <p><strong>Win Percentage:</strong> {{ win_rate }}%</p>
      </div>

      <!-- Head-to-Head Section -->
      <div class="matchup-box">
        <h2>Matchup History</h2>

        <select id="opponentSelect">
          <option value="">Select Opponent</option>

          {% for other in all_players %} {% if other != name %}
          <option value="{{ other }}">{{ other }}</option>
          {% endif %} {% endfor %}
        </select>

        <div id="matchupResults" class="matchup-results">
          <p>Select a player to view head-to-head stats.</p>
        </div>
      </div>

      <!-- BADGES SECTION -->
      {% if badges %}
      <div class="badge-section">
        <h2 class="badge-header">Badges</h2>

        <div class="badge-grid">
          {% for badge in badges %}
          <div class="badge-wrapper" onclick="toggleBadge(this)">
            <img
              src="{{ badge.icon }}"
              class="player-badge-icon"
              alt="{{ badge.name }}"
            />

            <div class="badge-popup">
              {{ badge.name }}<br />
              {{ badge.description }}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Character count -->
      <div class="player-summary">
        <p><strong>Total Characters Played:</strong> {{ total_chars }}</p>

        {% if best_char %}
        <p>
          <strong>Best Character:</strong> {{ best_char }} ({{
          char_map[best_char] }})
        </p>
        <p>
          <strong>Worst Character:</strong> {{ worst_char }} ({{
          char_map[worst_char] }})
        </p>
        {% endif %}
      </div>

      <table>
        <tr>
          <th>Character</th>
          <th>ELO</th>
        </tr>

        {% for char, elo in char_map | dictsort(by='value', reverse=true) %}
        <tr>
          <td>{{ char }}</td>
          <td>{{ elo }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>

    <script>
      async function loadMatchup() {
        const opp = document.getElementById("opponentSelect").value;
        if (!opp) return;

        const res = await fetch(`/api/matchup/{{ name }}/${opp}`);
        const data = await res.json();

        document.getElementById("matchupResults").innerHTML = `
          <div class="matchup-row">
            <div class="matchup-left">
              <p><strong>Total Games:</strong> ${data.total}</p>
              <p><strong>{{ name }} Wins:</strong> ${data.wins}</p>
              <p><strong>${opp} Wins:</strong> ${data.losses}</p>
            </div>

            <div class="matchup-right">
              <p><strong>Win Rate:</strong> ${data.win_rate}%</p>
            </div>
          </div>
        `;
      }

      document
        .getElementById("opponentSelect")
        .addEventListener("change", loadMatchup);
    </script>

    <script>
      function toggleBadge(wrapper) {
        // Close any other open badge
        document.querySelectorAll(".badge-wrapper.active").forEach((el) => {
          if (el !== wrapper) el.classList.remove("active");
        });

        // Toggle this one
        wrapper.classList.toggle("active");
      }

      // Close popup when tapping anywhere outside
      document.addEventListener(
        "click",
        function (e) {
          const openPopup = document.querySelector(".badge-wrapper.active");
          if (!openPopup) return;

          // If tap is not inside the active badge → close it
          if (!openPopup.contains(e.target)) {
            openPopup.classList.remove("active");
          }
        },
        true
      );
    </script>
  </body>
</html>
